<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WooCommerce Systemrapport Kontroll</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .results {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }
    .info {
      color: blue;
    }
    a {
      color: blue;
      text-decoration: none;
    }
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border: 1px solid #ccc;
      overflow-x: auto;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #0073e6;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #005bb5;
    }
  </style>
</head>
<body>
  <h1>WooCommerce Systemrapport Kontroll</h1>
  <p>Ladda upp en systemrapport (JSON) från WooCommerce.</p>
  
  <input type="file" id="fileInput" accept=".json">
  <div id="results" class="results"></div>
  <button id="downloadButton" style="display: none;">Ladda ner systemrapport</button>
  <pre id="formattedJson" style="display: none;"></pre>

  <script>
    let jsonData = null;

    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file && file.name.endsWith('.json')) {
        const reader = new FileReader();

        reader.onload = function(e) {
          try {
            jsonData = JSON.parse(e.target.result);
            analyzeJsonReport(jsonData);
            displayFormattedJson(jsonData);
          } catch (error) {
            document.getElementById('results').innerHTML = `<p class="error">Ogiltig JSON-fil: ${error.message}</p>`;
          }
        };

        reader.readAsText(file);
      } else {
        document.getElementById('results').innerHTML = `<p class="error">Endast JSON-filer stöds.</p>`;
      }
    });

    function analyzeJsonReport(data) {
      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = ''; // Rensa tidigare resultat

      const checks = [];

      // Site URL
      if (data.environment && data.environment.site_url) {
        const siteUrl = data.environment.site_url;
        checks.push(`<p class="info">Webbplats URL: <a href="${siteUrl}" target="_blank">${siteUrl}</a></p>`);
      } else {
        checks.push(`<p class="error">Webbplatsens URL kunde inte hittas i JSON-rapporten.</p>`);
      }

      // WordPress-version
      if (data.environment && data.environment.wp_version) {
        const wpVersion = data.environment.wp_version;
        checks.push(`<p class="info">WordPress-version: ${wpVersion}.</p>`);
      } else {
        checks.push(`<p class="error">WordPress-version kunde inte hittas i JSON-rapporten.</p>`);
      }

      // WooCommerce-version
      let wcVersion = data.environment && data.environment.version ? data.environment.version : "Okänd";
      let wcLatestVersion = data.environment && data.environment.version_latest ? data.environment.version_latest : null;

      if (!wcLatestVersion && data.active_plugins) {
        const wooPlugin = data.active_plugins.find(plugin => plugin.name === "WooCommerce");
        if (wooPlugin) {
          wcLatestVersion = wooPlugin.version_latest;
        }
      }

      if (wcVersion !== "Okänd") {
        checks.push(`<p class="info">WooCommerce-version: ${wcVersion}.</p>`);
        if (wcLatestVersion) {
          if (wcVersion === wcLatestVersion) {
            checks.push(`<p class="success">WooCommerce är uppdaterad till senaste version (${wcVersion}).</p>`);
          } else {
            checks.push(`<p class="error">WooCommerce är inte uppdaterad. Installerad version: ${wcVersion}, senaste version: ${wcLatestVersion}.</p>`);
          }
        } else {
          checks.push(`<p class="error">Senaste WooCommerce-version kunde inte hittas.</p>`);
        }
      }

      // PHP-version
      if (data.environment && data.environment.php_version) {
        const phpVersion = data.environment.php_version;
        checks.push(`<p class="info">PHP-version: ${phpVersion}.</p>`);
      } else {
        checks.push(`<p class="error">PHP-version kunde inte hittas i JSON-rapporten.</p>`);
      }

      // Decimaler
      if (data.settings && data.settings.number_of_decimals !== undefined) {
        const decimals = data.settings.number_of_decimals;
        if (decimals === 2) {
          checks.push(`<p class="success">Antalet decimaler är korrekt inställt (${decimals}).</p>`);
        } else {
          checks.push(`<p class="error">Antalet decimaler är inställt på ${decimals}. Det bör vara 2.</p>`);
        }
      }

      // Tema
      if (data.theme) {
        const themeName = data.theme.name || 'Okänt tema';
        const themeVersion = data.theme.version || 'Okänd version';
        const themeLatestVersion = data.theme.version_latest || 'Okänd senaste version';
        checks.push(`<p class="info">Tema: ${themeName} (Version: ${themeVersion}).</p>`);
        if (themeVersion === themeLatestVersion) {
          checks.push(`<p class="success">Temat "${themeName}" är uppdaterat till senaste version (${themeVersion}).</p>`);
        } else {
          checks.push(`<p class="error">Temat "${themeName}" är inte uppdaterat. Installerad version: ${themeVersion}, senaste version: ${themeLatestVersion}.</p>`);
        }
      }

      // Plugins
      if (data.active_plugins && data.active_plugins.length > 0) {
        checks.push("<p class='info'>Aktiva plugins:</p><ul>");
        data.active_plugins.forEach(plugin => {
          if (plugin.version === plugin.version_latest) {
            checks.push(`<li class="success">${plugin.name} (Version: ${plugin.version}) är uppdaterad.</li>`);
          } else {
            checks.push(`<li class="error">${plugin.name} (Version: ${plugin.version}) är inte uppdaterad. Senaste versionen är ${plugin.version_latest}.</li>`);
          }
        });
        checks.push("</ul>");
      } else {
        checks.push(`<p class="error">Ingen information om aktiva plugins hittades i JSON-rapporten.</p>`);
      }

      resultsContainer.innerHTML = checks.join('');
    }

    function displayFormattedJson(data) {
      const formattedJsonContainer = document.getElementById('formattedJson');
      const downloadButton = document.getElementById('downloadButton');

      formattedJsonContainer.textContent = JSON.stringify(data, null, 2);
      formattedJsonContainer.style.display = 'block';

      downloadButton.style.display = 'inline-block';
      downloadButton.onclick = function () {
        const fileName = (data.environment.home_url || 'systemrapport').replace(/https?:\/\//, '').replace(/[^\w\-]/g, '_') + '_systemrapport.json';
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
      };
    }
  </script>
</body>
</html>
